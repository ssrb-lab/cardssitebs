name: Deploy to Hetzner

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 188.245.248.248
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # Переходимо в папку проекту на сервері
            cd /var/www/cardssitebs || exit
            
            # Отримуємо свій код
            git reset --hard origin/main || git reset --hard origin/master
            git pull origin main || git pull origin master
            
            # Копіюємо .env файли
            cp .env.production .env || true
            cp .env.production backend/.env || true
            
            # Встановлюємо залежності та білдимо фронтенд
            npm install
            npm run build
            
            # Налаштовуємо бекенд
            cd backend
            npm install
            
            # Міграції бази даних (якщо використовується Prisma)
            npx prisma generate
            npx prisma migrate deploy || true
            
            # Перезапускаємо бекенд через PM2
            pm2 restart backend || pm2 start server.js --name backend
